
// package com.example.truenorthdemoproject;
// import android.Manifest;
// import android.app.Notification;
// import android.app.NotificationChannel;
// import android.app.NotificationManager;
// import android.app.Service;
// import android.content.Intent;
// import android.content.pm.PackageManager;
// import android.location.Location;
// import android.location.LocationManager;
// import android.os.Build;
// import android.os.Handler;
// import android.os.IBinder;
// import android.os.Looper;

// import androidx.annotation.Nullable;
// import androidx.core.app.ActivityCompat;
// import androidx.core.app.NotificationCompat;

// import java.io.OutputStream;
// import java.net.HttpURLConnection;
// import java.net.URL;

// public class LocationService extends Service {

//     private static final String CHANNEL_ID = "location_channel";
//     private Handler handler = new Handler();
//     private Runnable runnable;

//     @Nullable
//     @Override
//     public IBinder onBind(Intent intent) {
//         return null;
//     }

//     @Override
//     public void onCreate() {
//         super.onCreate();
//         createNotificationChannel();

//         Notification notification = new NotificationCompat.Builder(this, CHANNEL_ID)
//                 .setContentTitle("Location Service Running")
//                 .setContentText("Tracking your location every 10 minutes")
//                 .setSmallIcon(R.mipmap.ic_launcher)
//                 .build();

//         
// (1, notification);

//         startLocationUpdates();
//     }

//     // private void startLocationUpdates() {
//         runnable = new Runnable() {
//             @Override
//             public void run() {
//                 getAndSendLocation();
//                 handler.postDelayed(this, 10 * 60 * 1000); // every 10 minutes
//                 // handler.postDelayed(this, 10 * 1000);//e
                
//             }
//         };
//         handler.post(runnable);
//     }
  

//     private void getAndSendLocation() {
//         LocationManager lm = (LocationManager) getSystemService(LOCATION_SERVICE);

//         boolean isGpsEnabled = lm.isProviderEnabled(LocationManager.GPS_PROVIDER);
//         if (!isGpsEnabled) {
//             // ðŸ”¥ You can trigger a notification or broadcast to Flutter
//             System.out.println("âš ï¸ GPS is OFF! Please enable location.");
//             stopSelf(); // Optional: stop service if GPS is off
//             return;
//         }

//         if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION)
//                 != PackageManager.PERMISSION_GRANTED) {
//             System.out.println("âš ï¸ Location permission not granted");
//             return;
//         }

//         Location location = lm.getLastKnownLocation(LocationManager.GPS_PROVIDER);
//         if (location != null) {
//             double lat = location.getLatitude();
//             double lon = location.getLongitude();
//             System.out.println("ðŸ“ Latitude: " + lat + ", Longitude: " + lon);

//             // Send to your API
//            // sendToServer(lat, lon);
//         }
//     }

//     private void sendToServer(double lat, double lon) {
//         new Thread(() -> {
//             try {
//                 URL url = new URL("https://your-springboot-api.com/api/location");
//                 HttpURLConnection conn = (HttpURLConnection) url.openConnection();
//                 conn.setRequestMethod("POST");
//                 conn.setRequestProperty("Content-Type", "application/json");
//                 conn.setDoOutput(true);

//                 String json = "{\"userId\": \"123\", \"latitude\": " + lat + ", \"longitude\": " + lon + "}";
//                 OutputStream os = conn.getOutputStream();
//                 os.write(json.getBytes());
//                 os.flush();
//                 os.close();

//                 int responseCode = conn.getResponseCode();
//                 System.out.println("ðŸŒ API Response Code: " + responseCode);

//                conn.disconnect();
//             } catch (Exception e) {
//                 e.printStackTrace();
//             }
//         }).start();
//     }

//     private void createNotificationChannel() {
//         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
//             NotificationChannel serviceChannel = new NotificationChannel(
//                     CHANNEL_ID,
//                     "Location Tracking Channel",
//                     NotificationManager.IMPORTANCE_DEFAULT
//             );
//             NotificationManager manager = getSystemService(NotificationManager.class);
//             manager.createNotificationChannel(serviceChannel);
//         }
//     }

//     @Override
//     public void onDestroy() {
//         super.onDestroy();
//         handler.removeCallbacks(runnable);
//     }
// }
// package com.example.truenorthdemoproject;

// import android.Manifest;
// import android.app.Notification;
// import android.app.NotificationChannel;
// import android.app.NotificationManager;
// import android.app.Service;
// import android.content.Intent;
// import android.content.pm.PackageManager;
// import android.location.Location;
// import android.location.LocationManager;
// import android.os.Build;
// import android.os.Handler;
// import android.os.IBinder;
// import android.os.Looper;

// import androidx.annotation.Nullable;
// import androidx.core.app.ActivityCompat;
// import androidx.core.app.NotificationCompat;

// import java.io.OutputStream;
// import java.net.HttpURLConnection;
// import java.net.URL;

// public class LocationService extends Service {

//     private static final String CHANNEL_ID = "location_channel";
//     private Handler handler = new Handler(Looper.getMainLooper());
//     private Runnable runnable;

//     @Nullable
//     @Override
//     public IBinder onBind(Intent intent) {
//         return null;
//     }

//     @Override
//     public void onCreate() {
//         super.onCreate();
//         createNotificationChannel();

//         Notification notification = new NotificationCompat.Builder(this, CHANNEL_ID)
//                 .setContentTitle("Location Service Running")
//                 .setContentText("Tracking your location every 10 seconds (test mode)")
//                 .setSmallIcon(R.mipmap.ic_launcher)
//                 .build();

//         startForeground(1, notification);

//         startLocationUpdates();
//     }

//     private void startLocationUpdates() {
//         runnable = new Runnable() {
//             @Override
//             public void run() {
//                 getAndSendLocation();
//                 handler.postDelayed(this, 10 * 1000); // â± every 10 seconds for testing
//             }
//         };
//         handler.post(runnable);
//     }
// private void getAndSendLocation() {
//     LocationManager lm = (LocationManager) getSystemService(LOCATION_SERVICE);

//     boolean isGpsEnabled = lm.isProviderEnabled(LocationManager.GPS_PROVIDER);
//     if (!isGpsEnabled) {
//         System.out.println("âš ï¸ GPS is OFF! Please enable location.");
//         //stopSelf();
//         Intent intent = new Intent(android.provider.Settings.ACTION_LOCATION_SOURCE_SETTINGS);
//         intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
//         startActivity(intent);
//         return;
//     }

//     if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION)
//             != PackageManager.PERMISSION_GRANTED &&
//         ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_COARSE_LOCATION)
//             != PackageManager.PERMISSION_GRANTED) {
//         System.out.println("âš ï¸ Location permission not granted");

//        // ActivityCompat.requestPermissions(this, new String[]{Manifest.permission.ACCESS_FINE_LOCATION}, 1);
       
//         return;
//     }
   

//     // âœ… Request location update (forces fresh location)
//     lm.requestSingleUpdate(LocationManager.GPS_PROVIDER, location -> {
//         if (location != null) {
//             double lat = location.getLatitude();
//             double lon = location.getLongitude();
//             System.out.println("ðŸ“ Latitude: " + lat + ", Longitude: " + lon);

//             // sendToServer(lat, lon);
//         } else {
//             System.out.println("âŒ Could not get location yet.");
//         }
//     }, Looper.getMainLooper());
//      lm.requestLocationUpdates(
//             LocationManager.GPS_PROVIDER,
//             10 * 1000, // every 10 seconds for testing
//             0,
//             location -> {
//                 double lat = location.getLatitude();
//                 double lon = location.getLongitude();
//                 System.out.println("ðŸ“ Latitude: " + lat + ", Longitude: " + lon);

//                 // sendToServer(lat, lon);
//             }
//     );
// }

//     // private void getAndSendLocation() {
//     //     LocationManager lm = (LocationManager) getSystemService(LOCATION_SERVICE);

//     //     boolean isGpsEnabled = lm.isProviderEnabled(LocationManager.GPS_PROVIDER);
//     //     if (!isGpsEnabled) {
//     //         System.out.println("âš ï¸ GPS is OFF! Please enable location.");
//     //         stopSelf(); // stop service if GPS is off
//     //         return;
//     //     }

//     //     if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION)
//     //             != PackageManager.PERMISSION_GRANTED &&
//     //         ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_COARSE_LOCATION)
//     //             != PackageManager.PERMISSION_GRANTED) {
//     //         System.out.println("âš ï¸ Location permission not granted");
//     //         return;
//     //     }

//     //     Location location = lm.getLastKnownLocation(LocationManager.GPS_PROVIDER);
//     //     if (location != null) {
//     //         double lat = location.getLatitude();
//     //         double lon = location.getLongitude();
//     //         System.out.println("ðŸ“ Latitude: " + lat + ", Longitude: " + lon);

//     //         // Uncomment below line to test sending location to API
//     //         // sendToServer(lat, lon);
//     //     } else {
//     //         System.out.println("âŒ Could not get location yet.");
//     //     }
//     // }

//     private void sendToServer(double lat, double lon) {
//         new Thread(() -> {
//             try {
//                 URL url = new URL("https://your-springboot-api.com/api/location");
//                 HttpURLConnection conn = (HttpURLConnection) url.openConnection();
//                 conn.setRequestMethod("POST");
//                 conn.setRequestProperty("Content-Type", "application/json");
//                 conn.setDoOutput(true);

//                 String json = "{\"userId\": \"123\", \"latitude\": " + lat + ", \"longitude\": " + lon + "}";
//                 OutputStream os = conn.getOutputStream();
//                 os.write(json.getBytes());
//                 os.flush();
//                 os.close();

//                 int responseCode = conn.getResponseCode();
//                 System.out.println("ðŸŒ API Response Code: " + responseCode);

//                 conn.disconnect();
//             } catch (Exception e) {
//                 e.printStackTrace();
//             }
//         }).start();
//     }

//     private void createNotificationChannel() {
//         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
//             NotificationChannel serviceChannel = new NotificationChannel(
//                     CHANNEL_ID,
//                     "Location Tracking Channel",
//                     NotificationManager.IMPORTANCE_DEFAULT
//             );
//             NotificationManager manager = getSystemService(NotificationManager.class);
//             manager.createNotificationChannel(serviceChannel);
//         }
//     }

//     @Override
//     public void onDestroy() {
//         super.onDestroy();
//         handler.removeCallbacks(runnable);
//     }
// }
// package com.example.truenorthdemoproject;

// import android.app.Notification;
// import android.app.NotificationChannel;
// import android.app.NotificationManager;
// import android.app.Service;
// import android.content.Intent;
// import android.os.Build;
// import android.os.IBinder;
// import android.os.Handler;
// import android.location.Location;
// import android.util.Log;

// import androidx.annotation.Nullable;
// import androidx.core.app.NotificationCompat;

// import com.google.android.gms.location.FusedLocationProviderClient;
// import com.google.android.gms.location.LocationCallback;
// import com.google.android.gms.location.LocationRequest;
// import com.google.android.gms.location.LocationResult;
// import com.google.android.gms.location.LocationServices;

// public class LocationService extends Service {
//     private static final String CHANNEL_ID = "LocationServiceChannel";
//     private FusedLocationProviderClient fusedClient;
//     private LocationCallback locationCallback;

//     @Nullable
//     @Override
//     public IBinder onBind(Intent intent) {
//         return null;
//     }

//     @Override
//     public void onCreate() {
//         super.onCreate();
//         fusedClient = LocationServices.getFusedLocationProviderClient(this);
//         createNotificationChannel();

//         startForeground(1, getNotification("Location service started"));

//         requestLocationUpdates();
//     }

//     private Notification getNotification(String content) {
//         return new NotificationCompat.Builder(this, CHANNEL_ID)
//                 .setContentTitle("Surveyist Location Service")
//                 .setContentText(content)
//                 .setSmallIcon(android.R.drawable.ic_menu_mylocation)
//                 .build();
//     }

//     private void createNotificationChannel() {
//         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
//             NotificationChannel channel = new NotificationChannel(
//                     CHANNEL_ID,
//                     "Location Service Channel",
//                     NotificationManager.IMPORTANCE_LOW
//             );
//             NotificationManager manager = getSystemService(NotificationManager.class);
//             manager.createNotificationChannel(channel);
//         }
//     }

//     private void requestLocationUpdates() {
//         LocationRequest request = LocationRequest.create();
//         request.setInterval(10 * 1000); // 10 sec for testing
//         request.setFastestInterval(5000);
//         request.setPriority(LocationRequest.PRIORITY_HIGH_ACCURACY);

//         locationCallback = new LocationCallback() {
//             @Override
//             public void onLocationResult(LocationResult result) {
//                 for (Location location : result.getLocations()) {
//                     double lat = location.getLatitude();
//                     double lon = location.getLongitude();
//                     Log.i("LocationService", "Lat: " + lat + ", Lon: " + lon);

//                     // TODO: send location to your API here
//                 }
//             }
//         };

//         fusedClient.requestLocationUpdates(request, locationCallback, null);
//     }

//     @Override
//     public void onDestroy() {
//         super.onDestroy();
//         if (fusedClient != null && locationCallback != null) {
//             fusedClient.removeLocationUpdates(locationCallback);
//         }
//     }
// }
// package com.example.truenorthdemoproject;

// import android.Manifest;
// import android.app.Notification;
// import android.app.NotificationChannel;
// import android.app.NotificationManager;
// import android.app.Service;
// import android.content.Intent;
// import android.content.pm.PackageManager;
// import android.location.Location;
// import android.location.LocationManager;
// import android.os.Build;
// import android.os.Handler;
// import android.os.IBinder;
// import android.provider.Settings;

// import androidx.annotation.Nullable;
// import androidx.core.app.ActivityCompat;
// import androidx.core.app.NotificationCompat;

// import java.io.OutputStream;
// import java.net.HttpURLConnection;
// import java.net.URL;

// public class LocationService extends Service {

//     private static final String CHANNEL_ID = "location_channel";
//     private Handler handler = new Handler();
//     private Runnable runnable;

//     @Nullable
//     @Override
//     public IBinder onBind(Intent intent) {
//         return null;
//     }

//     @Override
//     public void onCreate() {
//         super.onCreate();
//         createNotificationChannel();

//         Notification notification = new NotificationCompat.Builder(this, CHANNEL_ID)
//                 .setContentTitle("Location Service Running")
//                 .setContentText("Tracking your location every few seconds")
//                 .setSmallIcon(R.mipmap.ic_launcher)
//                 .build();

//         startForeground(1, notification);

//         startLocationUpdates();
//     }

//     private void startLocationUpdates() {
//         runnable = new Runnable() {
//             @Override
//             public void run() {
//                 getAndSendLocation();
//                 // ðŸ” 10 seconds for testing (change to 10 * 60 * 1000 for 10 minutes)
//                 handler.postDelayed(this, 10 * 1000);
//             }
//         };
//         handler.post(runnable);
//     }




// private void getAndSendLocation() {
//     LocationManager lm = (LocationManager) getSystemService(LOCATION_SERVICE);

//     // ðŸ” Check if GPS is enabled
//     boolean isGpsEnabled = lm.isProviderEnabled(LocationManager.GPS_PROVIDER);
//     if (!isGpsEnabled) {
//         System.out.println("âš ï¸ GPS is OFF! Opening Location Settings...");
//         Intent intent = new Intent(Settings.ACTION_LOCATION_SOURCE_SETTINGS);
//         intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
//         startActivity(intent);
//         return;
//     }

//     // ðŸ” Check if location permission is granted
//     if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION)
//             != PackageManager.PERMISSION_GRANTED) {

//         System.out.println("âš ï¸ Location permission NOT granted. Opening App Settings...");

//         // ðŸ”“ Open App Settings to let the user enable permissions
//         Intent intent = new Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);
//         intent.setData(android.net.Uri.parse("package:" + getPackageName()));
//         intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
//         startActivity(intent);

//         return;
//     }

//     // âœ… Request live location updates
//     lm.requestLocationUpdates(
//             LocationManager.GPS_PROVIDER,
//             5000, // 5 seconds
//             0,    // 0 meters change
//             location -> {
//                 double lat = location.getLatitude();
//                 double lon = location.getLongitude();
//                 System.out.println("ðŸ“ Latitude: " + lat + ", Longitude: " + lon);
//                 // sendToServer(lat, lon);
//             }
//     );
// }


//     // private void getAndSendLocation() {
//     //     LocationManager lm = (LocationManager) getSystemService(LOCATION_SERVICE);

//     //     // ðŸ” Check if GPS is enabled
//     //     boolean isGpsEnabled = lm.isProviderEnabled(LocationManager.GPS_PROVIDER);
//     //     if (!isGpsEnabled) {
//     //         System.out.println("âš ï¸ GPS is OFF! Opening settings...");
//     //         Intent intent = new Intent(Settings.ACTION_LOCATION_SOURCE_SETTINGS);
//     //         intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
//     //         startActivity(intent);
//     //         return;
//     //     }

//     //     // ðŸ” Check permission
//     //     if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION)
//     //             != PackageManager.PERMISSION_GRANTED) {
//     //         System.out.println("âš ï¸ Location permission not granted.");
//     //         return;
//     //     }

//     //     // ðŸ“ Get last known location
//     //     Location location = lm.getLastKnownLocation(LocationManager.GPS_PROVIDER);
//     //     if (location != null) {
//     //         double lat = location.getLatitude();
//     //         double lon = location.getLongitude();
//     //         System.out.println("ðŸ“ Latitude: " + lat + ", Longitude: " + lon);

//     //         // âœ… You can call API here
//     //         // sendToServer(lat, lon);
//     //     } else {
//     //         System.out.println("âŒ Could not get location yet.");
//     //     }
//     // }

//     private void sendToServer(double lat, double lon) {
//         new Thread(() -> {
//             try {
//                 URL url = new URL("https://your-springboot-api.com/api/location");
//                 HttpURLConnection conn = (HttpURLConnection) url.openConnection();
//                 conn.setRequestMethod("POST");
//                 conn.setRequestProperty("Content-Type", "application/json");
//                 conn.setDoOutput(true);

//                 String json = "{\"userId\": \"123\", \"latitude\": " + lat + ", \"longitude\": " + lon + "}";
//                 OutputStream os = conn.getOutputStream();
//                 os.write(json.getBytes());
//                 os.flush();
//                 os.close();

//                 int responseCode = conn.getResponseCode();
//                 System.out.println("ðŸŒ API Response Code: " + responseCode);

//                 conn.disconnect();
//             } catch (Exception e) {
//                 e.printStackTrace();
//             }
//         }).start();
//     }

//     private void createNotificationChannel() {
//         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
//             NotificationChannel serviceChannel = new NotificationChannel(
//                     CHANNEL_ID,
//                     "Location Tracking Channel",
//                     NotificationManager.IMPORTANCE_DEFAULT
//             );
//             NotificationManager manager = getSystemService(NotificationManager.class);
//             manager.createNotificationChannel(serviceChannel);
//         }
//     }

//     @Override
//     public void onDestroy() {
//         super.onDestroy();
//         handler.removeCallbacks(runnable);
//         System.out.println("ðŸ›‘ Location service stopped.");
//     }
// }
// package com.example.truenorthdemoproject;

// import android.Manifest;
// import android.app.Notification;
// import android.app.NotificationChannel;
// import android.app.NotificationManager;
// import android.app.Service;
// import android.content.Intent;
// import android.content.pm.PackageManager;
// import android.location.Location;
// import android.location.LocationListener;
// import android.location.LocationManager;
// import android.os.Build;
// import android.os.Handler;
// import android.os.IBinder;
// import android.provider.Settings;

// import androidx.annotation.Nullable;
// import androidx.core.app.ActivityCompat;
// import androidx.core.app.NotificationCompat;

// import java.io.OutputStream;
// import java.net.HttpURLConnection;
// import java.net.URL;

// public class LocationService extends Service {

//     private static final String CHANNEL_ID = "location_channel";
//     private LocationManager locationManager;
//     private LocationListener locationListener;
//     private Handler handler = new Handler();
//     private Runnable runnable;

//     @Nullable
//     @Override
//     public IBinder onBind(Intent intent) {
//         return null;
//     }

//     @Override
//     public void onCreate() {
//         super.onCreate();
//         createNotificationChannel();

//         Notification notification = new NotificationCompat.Builder(this, CHANNEL_ID)
//                 .setContentTitle("Location Service Running")
//                 .setContentText("Tracking your location")
//                 .setSmallIcon(R.mipmap.ic_launcher)
//                 .build();

//         startForeground(1, notification);

//         startLocationUpdates();
//     }

//     private void startLocationUpdates() {
//         locationManager = (LocationManager) getSystemService(LOCATION_SERVICE);

//         locationListener = location -> {
//             double lat = location.getLatitude();
//             double lon = location.getLongitude();
//             System.out.println("ðŸ“ Latitude: " + lat + ", Longitude: " + lon);
//           //  sendToServer(lat, lon);
//         };

//         runnable = new Runnable() {
//             @Override
//             public void run() {
//                 checkAndRequestLocation();
//                 // Retry every 10 seconds
//                 handler.postDelayed(this, 10000);
//             }
//         };
//         handler.post(runnable);
//     }

//     private void checkAndRequestLocation() {
//         // Check permission
//         if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION)
//                 != PackageManager.PERMISSION_GRANTED) {
//             System.out.println("âš ï¸ Permission not granted! Opening app settings...");
//             Intent intent = new Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);
//             intent.setData(android.net.Uri.parse("package:" + getPackageName()));
//             intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
//             startActivity(intent);
//             return;
//         }

//         // Check GPS
//         if (!locationManager.isProviderEnabled(LocationManager.GPS_PROVIDER)) {
//             System.out.println("âš ï¸ GPS OFF! Opening location settings...");
//             Intent intent = new Intent(Settings.ACTION_LOCATION_SOURCE_SETTINGS);
//             intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
//             startActivity(intent);
//             return;
//         }

//         // Request location updates
//         locationManager.requestLocationUpdates(
//                 LocationManager.GPS_PROVIDER,
//                 5000,
//                 0,
//                 locationListener
//         );
//     }

//     // private void sendToServer(double lat, double lon) {
//     //     new Thread(() -> {
//     //         try {
//     //             URL url = new URL("https://your-springboot-api.com/api/location");
//     //             HttpURLConnection conn = (HttpURLConnection) url.openConnection();
//     //             conn.setRequestMethod("POST");
//     //             conn.setRequestProperty("Content-Type", "application/json");
//     //             conn.setDoOutput(true);

//     //             String json = "{\"userId\": \"123\", \"latitude\": " + lat + ", \"longitude\": " + lon + "}";
//     //             OutputStream os = conn.getOutputStream();
//     //             os.write(json.getBytes());
//     //             os.flush();
//     //             os.close();

//     //             int responseCode = conn.getResponseCode();
//     //             System.out.println("ðŸŒ API Response Code: " + responseCode);

//     //             conn.disconnect();
//     //         } catch (Exception e) {
//     //             e.printStackTrace();
//     //         }
//     //     }).start();
//     // }

//     private void createNotificationChannel() {
//         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
//             NotificationChannel channel = new NotificationChannel(
//                     CHANNEL_ID,
//                     "Location Tracking",
//                     NotificationManager.IMPORTANCE_DEFAULT
//             );
//             NotificationManager manager = getSystemService(NotificationManager.class);
//             manager.createNotificationChannel(channel);
//         }
//     }

//     @Override
//     public void onDestroy() {
//         super.onDestroy();
//         handler.removeCallbacks(runnable);
//         if (locationManager != null && locationListener != null) {
//             locationManager.removeUpdates(locationListener);
//         }
//         System.out.println("ðŸ›‘ Location service stopped.");
//     }
// }
package com.example.truenorthdemoproject;

import android.Manifest;
import android.app.AlarmManager;
import android.app.NotificationChannel;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.app.Service;
import android.content.Context;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.location.Location;
import android.location.LocationListener;
import android.location.LocationManager;
import android.net.Uri;
import android.os.Build;
import android.os.Handler;
import android.os.IBinder;
import android.os.SystemClock;
import android.provider.Settings;
import android.os.PowerManager;

import androidx.annotation.Nullable;
import androidx.core.app.ActivityCompat;
import androidx.core.app.NotificationCompat;

public class LocationService extends Service {

    private static final String CHANNEL_ID = "location_channel";
    private LocationManager locationManager;
    private LocationListener locationListener;
    private Handler handler = new Handler();
    private Runnable runnable;

    @Nullable
    @Override
    public IBinder onBind(Intent intent) {
        return null;
    }

    @Override
    public void onCreate() {
        super.onCreate();
        createNotificationChannel();

        // Foreground notification
        NotificationCompat.Builder builder = new NotificationCompat.Builder(this, CHANNEL_ID)
                .setContentTitle("Location Service Running")
                .setContentText("Tracking your location")
                .setSmallIcon(R.mipmap.ic_launcher)
                .setPriority(NotificationCompat.PRIORITY_LOW);

        startForeground(1, builder.build());

        // Start location updates
        startLocationUpdates();

        // Prompt user to disable battery optimizations for this app
        requestBatteryOptimization();
         registerGpsSwitchReceiver();
    }

    @Override
    public int onStartCommand(Intent intent, int flags, int startId) {
        // Ensure service restarts if killed
        return START_STICKY;
    }
private void registerGpsSwitchReceiver() {
    gpsSwitchStateReceiver = new BroadcastReceiver() {
        @Override
        public void onReceive(Context context, Intent intent) {
            if (intent.getAction() != null &&
                intent.getAction().matches("android.location.PROVIDERS_CHANGED")) {
                // GPS ON/OFF changed, try fetching location again
                checkAndRequestLocation();
            }
        }
    };
    IntentFilter filter = new IntentFilter(LocationManager.PROVIDERS_CHANGED_ACTION);
    filter.addAction(Intent.ACTION_PROVIDER_CHANGED); // some devices
    registerReceiver(gpsSwitchStateReceiver, filter);
}
    private void startLocationUpdates() {
        locationManager = (LocationManager) getSystemService(LOCATION_SERVICE);

        locationListener = new LocationListener() {
            @Override
            public void onLocationChanged(Location location) {
                double lat = location.getLatitude();
                double lon = location.getLongitude();
                System.out.println("ðŸ“ Latitude: " + lat + ", Longitude: " + lon);
                // sendToServer(lat, lon); // Optional
            }
        };

        runnable = new Runnable() {
            @Override
            public void run() {
                checkAndRequestLocation();
                handler.postDelayed(this, 10000); // Retry every 10 seconds
            }
        };
        handler.post(runnable);
    }

    private void checkAndRequestLocation() {
        // Permission check
        if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION)
                != PackageManager.PERMISSION_GRANTED) {
            System.out.println("âš ï¸ Permission not granted! Opening app settings...");
            openAppSettings();
            return;
        }

        // GPS check
        if (!locationManager.isProviderEnabled(LocationManager.GPS_PROVIDER)) {
            System.out.println("âŒ GPS is OFF! Opening location settings...");
            openLocationSettings();
            return;
        }

        // Request location updates
        locationManager.requestLocationUpdates(
                LocationManager.GPS_PROVIDER,
                5000,
                0,
                locationListener
        );
    }

    private void openLocationSettings() {
        Intent intent = new Intent(Settings.ACTION_LOCATION_SOURCE_SETTINGS);
        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        startActivity(intent);
    }

    private void openAppSettings() {
        Intent intent = new Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);
        intent.setData(Uri.parse("package:" + getPackageName()));
        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        startActivity(intent);
    }

    private void createNotificationChannel() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            NotificationChannel channel = new NotificationChannel(
                    CHANNEL_ID,
                    "Location Tracking",
                    NotificationManager.IMPORTANCE_LOW
            );
            NotificationManager manager = getSystemService(NotificationManager.class);
            manager.createNotificationChannel(channel);
        }
    }

    private void requestBatteryOptimization() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            PowerManager pm = (PowerManager) getSystemService(Context.POWER_SERVICE);
            if (!pm.isIgnoringBatteryOptimizations(getPackageName())) {
                Intent intent = new Intent(Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS);
                intent.setData(Uri.parse("package:" + getPackageName()));
                intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                startActivity(intent);
            }
        }
    }

    // This ensures the service restarts even if the app is removed from recent apps
    @Override
    public void onTaskRemoved(Intent rootIntent) {
        super.onTaskRemoved(rootIntent);

        Intent restartServiceIntent = new Intent(getApplicationContext(), LocationService.class);
        restartServiceIntent.setPackage(getPackageName());

        PendingIntent restartServicePendingIntent = PendingIntent.getService(
                getApplicationContext(),
                1,
                restartServiceIntent,
                PendingIntent.FLAG_ONE_SHOT | PendingIntent.FLAG_IMMUTABLE
        );

        AlarmManager alarmService = (AlarmManager) getSystemService(Context.ALARM_SERVICE);
        alarmService.set(
                AlarmManager.ELAPSED_REALTIME,
                SystemClock.elapsedRealtime() + 1000, // restart after 1 second
                restartServicePendingIntent
        );
    }

   @Override
public void onDestroy() {
    super.onDestroy();
    handler.removeCallbacks(runnable);
    if (locationManager != null && locationListener != null) {
        locationManager.removeUpdates(locationListener);
    }
    if (gpsSwitchStateReceiver != null) {
        unregisterReceiver(gpsSwitchStateReceiver);
    }
    System.out.println("ðŸ›‘ Location service stopped.");
}
}
